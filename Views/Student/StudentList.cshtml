@model List<SIMS.Models.Student>

@{
    Layout = "_AdminLayout";
}

<h2>Students List</h2>
<div class="actionBtnBox">
    <form></form>
    <button id="searchBtn" class="btn btn-primary" style="margin-bottom: 1vh;">Search</button>
    <button id="filterBtn" type="button" class="btn btn-secondary" style="margin-bottom: 1vh;">Filter</button>
    <button id="addBtn" class="btn btn-success" style="margin-bottom: 1vh;">Add</button>
    <button id="editBtn" class="btn btn-warning" style="margin-bottom: 1vh;">Edit</button>
    <button id="deleteBtn" class="btn btn-danger" style="margin-bottom: 1vh;">Delete</button>
</div>

<div style="max-width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fafafa;">

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Action</th>
                <th>Person ID</th>
                <th>Full Name</th>
                <th>Citizen ID</th>
                <th>Gender</th>
                <th>Date of Birth</th>
                <th>Email</th>
                <th>Phone Number</th>
                <th>Address</th>
                <th>Nationality</th>
                <th>Student ID</th>
                <th>Student Code</th>
                <th>Program ID</th>
                <th>Enrollment Date</th>
                <th>Current Semester</th>
                <th>Status ID</th>
                <th>GPA</th>
                <th>Credits Earned</th>
                <th>Expected Graduate Date</th>
                <th>Relatives' Phone</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var s in Model)
            {
                <tr>
                    <td>
                        <button class="btn btn-info btn-sm view-details" data-id="@s.StudentId">View</button>
                    </td>
                    <td><a>@s.PersonId</a></td>
                    <td>
                        <a href="#" class="view-details" data-id="@s.StudentId">
                            @s.FullName
                        </a>
                    </td>    
                    <td>@s.CitizenIdNumber</td>
                    <td>@(s.Gender.HasValue ? (s.Gender.Value ? "Male" : "Female") : "N/A")</td>
                    <td>@(s.DateOfBirth.HasValue? s.DateOfBirth.Value.ToString("yyyy-MM-dd") : "N/A")</td>
                    <td>@s.Email</td>
                    <td>@s.PhoneNumber</td>
                    <td>@s.Address</td>
                    <td>@s.Nationality</td>
                    <td>@s.StudentId</td>
                    <td>@s.StudentCode</td>
                    <td>@s.ProgramId</td>
                    <td>@s.EnrollmentDate.ToString("yyyy-MM-dd")</td>
                    <td>@s.CurrentSemester</td>
                    <td>@s.StudentStatusId</td>
                    <td>@s.GPA</td>
                    <td>@s.CreditsEarned</td>
                    <td>@s.ExpectedGraduateDate.ToString("yyyy-MM-dd")</td>
                    <td>@s.PhoneNumberOfRelatives</td>
                    

                </tr>
            }
        </tbody>
    </table>
</div>

@* Render cái `StudentDetailModal` vào đây. Tái sử dụng code*@
@await Html.PartialAsync("StudentDetailModal")

@* Filter Modal *@
<div id="filterModal" class="user-modal">
    <div class="user-modal-content">
        <span class="close-modal" id="closeFilterModal">&times;</span>
        <h3>Filter Students</h3>
        <div class="row g-3" style="margin-top:12px;">
            <div class="col-md-6">
                <label for="filterName" class="form-label">Name contains</label>
                <input type="text" class="form-control" id="filterName" />
            </div>
            <div class="col-md-3">
                <label for="filterGender" class="form-label">Gender</label>
                <select class="form-select" id="filterGender">
                    <option value="">Any</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filterSemester" class="form-label">Semester</label>
                <input type="number" min="1" class="form-control" id="filterSemester" />
            </div>
            <div class="col-md-6">
                <label for="filterProgram" class="form-label">Program Id</label>
                <input type="text" class="form-control" id="filterProgram" />
            </div>
            <div class="col-12" style="margin-top:8px;">
                <button id="applyFilterBtn" type="button" class="btn btn-primary">Apply</button>
                <button id="clearFilterBtn" type="button" class="btn btn-outline-secondary">Clear</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/StudentList.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Bootstrap 5 modal instance
            const studentModalElement = document.getElementById('studentDetailModal');
            const studentModal = new bootstrap.Modal(studentModalElement);

            $(".view-details").click(function(e) {
                e.preventDefault();
                const studentId = $(this).data("id");

                $.get("/Student/GetStudentById", { id: studentId }, function(data) {
                    $("#studentId").val(data.studentId);
                    $("#fullName").val(data.fullName);
                    $("#email").val(data.email);
                    $("#phone").val(data.phoneNumber);
                    $("#address").val(data.address);
                    studentModal.show();
                    // console.log(data);
                });
            });

            $("#saveChangesBtn").click(function() {
                const updatedData = {
                    StudentId: $("#studentId").val(),
                    PhoneNumber: $("#phone").val(),
                    Address: $("#address").val()
                };

                $.ajax({
                    type: "POST",
                    url: "/Student/UpdateStudent",
                    data: updatedData,
                    success: function() {
                        alert("Saved successfully!");
                        studentModal.hide();
                        location.reload();
                    }
                });
            });

            // Filter modal open/close
            $("#filterBtn").on("click", function() {
                $("#filterModal").css("display", "flex");
            });
            $("#closeFilterModal").on("click", function() {
                $("#filterModal").hide();
            });
            // Close when clicking outside content
            $("#filterModal").on("click", function(e) {
                if (e.target === this) {
                    $(this).hide();
                }
            });

            // Placeholder handlers
            $("#applyFilterBtn").on("click", function() {
                const filters = {
                    name: $("#filterName").val(),
                    gender: $("#filterGender").val(),
                    semester: $("#filterSemester").val(),
                    program: $("#filterProgram").val()
                };
                console.log("Apply filters:", filters);
                $("#filterModal").hide();
                // TODO: Hook up to server-side filtering or client-side filtering as needed

                // Toggle filter indicator (red dot) if any filter is set
                const anyFilter =
                    (filters.name && filters.name.trim().length > 0) ||
                    (filters.gender && filters.gender.trim().length > 0) ||
                    (filters.semester && String(filters.semester).trim().length > 0) ||
                    (filters.program && filters.program.trim().length > 0);

                if (anyFilter) {
                    $("#filterBtn").addClass("has-active-filters");
                } else {
                    $("#filterBtn").removeClass("has-active-filters");
                }
            });
            $("#clearFilterBtn").on("click", function() {
                $("#filterName").val("");
                $("#filterGender").val("");
                $("#filterSemester").val("");
                $("#filterProgram").val("");
                $("#filterBtn").removeClass("has-active-filters");
            });
        });
                // Test notifications cho các nút hành động
        $("#searchBtn").click(function () {
            alert("Search button clicked (chưa có logic).");
        });
        $("#addBtn").click(function () {
            alert("Add button clicked (chưa có logic).");
        });
        $("#editBtn").click(function () {
            alert("Edit button clicked (chưa có logic).");
        });
        $("#deleteBtn").click(function () {
            alert("Delete button clicked (chưa có logic).");
        });

    </script>
}


@model List<SIMS.Models.Person>

@{
    Layout = "_AdminLayout";
}

<h2>People List</h2>
<div class="actionBtnBox">
    <form></form>
    <button id="filterBtn" type="button" class="btn btn-primary" style="margin-bottom: 1vh;">Filter People</button>
    <button id="addBtn" class="btn btn-success" style="margin-bottom: 1vh;">Add a New Person</button>
</div>

<div style="max-width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fafafa;">

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Action</th>
                <th>Person ID</th>
                <th>Full Name</th>
                <th>Citizen ID</th>
                <th>Gender</th>
                <th>Date of Birth</th>
                <th>Email</th>
                <th>Phone Number</th>
                <th>Address</th>
                <th>Nationality</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in Model)
            {
                <tr>
                    <td>
                        <button class="btn btn-info btn-sm view-details" data-id="@p.PersonId">View</button>
                    </td>
                    <td>@p.PersonId</td>
                    <td>
                        <a href="#" class="view-details" data-id="@p.PersonId">
                            @p.FullName
                        </a>
                    </td>
                    <td>@p.CitizenIdNumber</td>
                    <td>@(p.Gender.HasValue ? (p.Gender.Value ? "Male" : "Female") : "N/A")</td>
                    <td>@(p.DateOfBirth.HasValue? p.DateOfBirth.Value.ToString("yyyy-MM-dd") : "N/A")</td>
                    <td>@p.Email</td>
                    <td>@p.PhoneNumber</td>
                    <td>@p.Address</td>
                    <td>@p.Nationality</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@* Add New Person Modal *@
<div id="addPersonModal" class="user-modal" style="display:none;">
    <div class="user-modal-content">
        <span class="close-modal" id="closeAddPersonModal">&times;</span>
        <h3>Add New Person</h3>
        <div class="row g-3" style="margin-top:12px;">
            <div class="col-md-6">
                <label for="personFullName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="personFullName" placeholder="Required" />
            </div>

            <div class="col-md-6">
                <label for="citizenIdNumber" class="form-label">Citizen ID (12 digits)</label>
                <input type="text" class="form-control" id="citizenIdNumber" maxlength="12" placeholder="e.g., 012345678901" />
            </div>

            <div class="col-md-4">
                <label for="personGender" class="form-label">Gender</label>
                <select class="form-select" id="personGender">
                    <option value="">-- Select --</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>

            <div class="col-md-4">
                <label for="personDob" class="form-label">Date of Birth</label>
                <input type="date" class="form-control" id="personDob" />
            </div>

            <div class="col-md-4">
                <label for="personNationality" class="form-label">Nationality</label>
                <input type="text" class="form-control" id="personNationality" placeholder="e.g., Vietnamese" />
            </div>

            <div class="col-md-6">
                <label for="personEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="personEmail" placeholder="example@domain.com" />
            </div>

            <div class="col-md-6">
                <label for="personPhone" class="form-label">Phone Number (10 digits, starts with 0)</label>
                <input type="text" class="form-control" id="personPhone" maxlength="10" placeholder="e.g., 0123456789" />
            </div>

            <div class="col-12">
                <label for="personAddress" class="form-label">Address</label>
                <input type="text" class="form-control" id="personAddress" placeholder="Address" />
            </div>

            <div class="col-12" style="margin-top:20px;">
                <button id="addNewPersonBtn" type="button" class="btn btn-success">Add</button>
                <button id="cancelAddNewPersonBtn" type="button" class="btn btn-outline-danger">Cancel</button>
            </div>
        </div>
    </div>
</div>



@* Filter Modal *@
<div id="filterModal" class="user-modal">
    <div class="user-modal-content">
        <span class="close-modal" id="closeFilterModal">&times;</span>
        <h3>Filter People</h3>
        <div class="row g-3" style="margin-top:12px;">
            <div class="col-md-2">
                <label for="filterPersonId" class="form-label">Id contains</label>
                <input type="text" class="form-control" id="filterPersonId" />
            </div>
            <div class="col-md-5">
                <label for="filterName" class="form-label">Name contains</label>
                <input type="text" class="form-control" id="filterName" />
            </div>
            <div class="col-md-5">
                <label for="filterCitizenIdNumber" class="form-label">Citizen ID contains</label>
                <input type="text" class="form-control" id="filterCitizenIdNumber" maxlength="12" placeholder="e.g., 012345678901" />
            </div>
            <div class="col-md-2">
                <label for="filterGender" class="form-label">Gender</label>
                <select class="form-select" id="filterGender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="col-md-5">
                <label for="filterPersonEmail" class="form-label">Email contains</label>
                <input type="email" class="form-control" id="ersonEmail" placeholder="example@domain.com" />
            </div>

            <div class="col-md-5">
                <label for="filterPersonPhone" class="form-label">Phone Number contains</label>
                <input type="text" class="form-control" id="filterPersonPhone" maxlength="10" placeholder="e.g., 0923456789" />
            </div>

            <div class="col-md-6">
                <label for="filterPersonDobStart" class="form-label">Date of Birth (start)</label>
                <input type="date" class="form-control" id="filterPersonDobStart" />
            </div>
            <div class="col-md-6">
                <label for="filterPersonDobEnd" class="form-label">Date of Birth (end)</label>
                <input type="date" class="form-control" id="filterPersonDobEnd" />
            </div>

            <div class="col-md-6">
                <label for="filterNationality" class="form-label">Nationality contains</label>
                <input type="text" class="form-control" id="filterNationality" value="Vietnamese" />
            </div>
            <div class="col-md-6">
                <label for="filterAddress" class="form-label">Address contains</label>
                <input type="text" class="form-control" id="filterAddress" />
            </div>
            <div class="col-12" style="margin-top:8px;">
                <button id="applyFilterBtn" type="button" class="btn btn-primary">Apply</button>
                <button id="clearFilterBtn" type="button" class="btn btn-outline-secondary">Clear</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            $(".view-details").click(function(e) {
                e.preventDefault();
                const personId = $(this).data("id");
                console.log("View person:", personId);
                alert("View person details for ID: " + personId + " (chưa có logic).");
            });

            // Filter modal open/close
            $("#filterBtn").on("click", function() {
                $("#filterModal").css("display", "flex");
            });
            $("#closeFilterModal").on("click", function() {
                $("#filterModal").hide();
            });
            // Close when clicking outside content
            $("#filterModal").on("click", function(e) {
                if (e.target === this) {
                    $(this).hide();
                }
            });

            // Filter handlers
            $("#applyFilterBtn").on("click", function() {
                const filters = {
                    name: $("#filterName").val(),
                    gender: $("#filterGender").val(),
                    nationality: $("#filterNationality").val(),
                    email: $("#filterEmail").val(),
                    citizenId: $("#filterCitizenId").val()
                };
                console.log("Apply filters:", filters);
                $("#filterModal").hide();
                // TODO: Hook up to server-side filtering or client-side filtering as needed

                // Toggle filter indicator (red dot) if any filter is set
                const anyFilter =
                    (filters.name && filters.name.trim().length > 0) ||
                    (filters.gender && filters.gender.trim().length > 0) ||
                    (filters.nationality && filters.nationality.trim().length > 0) ||
                    (filters.email && filters.email.trim().length > 0) ||
                    (filters.citizenId && filters.citizenId.trim().length > 0);

                if (anyFilter) {
                    $("#filterBtn").addClass("has-active-filters");
                } else {
                    $("#filterBtn").removeClass("has-active-filters");
                }
            });

            $("#clearFilterBtn").on("click", function() {
                $("#filterPersonId").val("");
                $("#filterName").val("");
                $("#filterCitizenIdNumber").val("");
                $("#filterGender").val("Male");
                $("#filterPersonEmail").val("");
                $("#filterPersonPhone").val("");
                $("#filterPersonDobStart").val("");
                $("#filterPersonDobEnd").val("");
                $("#filterNationality").val("Vietnamese");
                $("#filterCitizenId").val("");
                $("#filterAddress").val("");
                filters = {};
                $("#filterBtn").removeClass("has-active-filters");
            });

            // Infinite scroll and filter setup
            // Render server values as numeric literals
            let currentPages = @

            // Add Person modal handlers
            $("#addBtn").on("click", function () {
                // reset form
                $("#personFullName").val("");
                $("#citizenIdNumber").val("");
                $("#personGender").val("");
                $("#personDob").val("");
                $("#personNationality").val("");
                $("#personEmail").val("");
                $("#personPhone").val("");
                $("#personAddress").val("");
                $("#addPersonModal").css("display", "flex");
            });
            $("#closeAddPersonModal, #cancelAddNewPersonBtn").on("click", function () {
                $("#addPersonModal").hide();
            });
            // Close when clicking outside content
            $("#addPersonModal").on("click", function (e) {
                if (e.target === this) {
                    $(this).hide();
                }
            });

            function isValidCitizenId(id) {
                return /^\d{12}$/.test((id || "").toString().trim());
            }
            function isValidPhone(phone) {
                return /^0\d{9}$/.test((phone || "").toString().trim());
            }
            function isValidDob(d) {
                if (!d) return false;
                const dt = new Date(d);
                if (isNaN(dt.getTime())) return false;
                const today = new Date();
                if (dt > today) return false;
                return dt >= new Date(1900,0,1);
            }

            $("#addNewPersonBtn").on("click", function () {
                // alert("Adding new person...");
                const fullName = ($("#personFullName").val() || "").toString().trim();
                const citizenId = ($("#citizenIdNumber").val() || "").toString().trim();
                const genderText = ($("#personGender").val() || "").toString().trim();
                const dobRaw = $("#personDob").val();
                const email = ($("#personEmail").val() || "").toString().trim();
                const phone = ($("#personPhone").val() || "").toString().trim();
                const address = ($("#personAddress").val() || "").toString().trim();
                const nationality = ($("#personNationality").val() || "").toString().trim();

                // client-side validation
                if (!fullName) {
                    alert("Full name is required.");
                    return;
                }
                if (!isValidCitizenId(citizenId)) {
                    alert("Citizen ID must be exactly 12 digits.");
                    return;
                }
                if (!genderText) {
                    alert("Please select gender.");
                    return;
                }
                if (!isValidDob(dobRaw)) {
                    alert("Please provide a valid Date of Birth.");
                    return;
                }
                if (phone && !isValidPhone(phone)) {
                    alert("Phone number must start with 0 and contain 10 digits.");
                    return;
                }

                const payload = {
                    CitizenIdNumber: citizenId,
                    FullName: fullName,
                    Gender: genderText === "Male" ? true : false,
                    DateOfBirth: dobRaw,
                    Email: email,
                    PhoneNumber: phone,
                    Address: address,
                    Nationality: nationality
                };

                // disable button while submitting
                $("#addNewPersonBtn").prop("disabled", true).text("Adding...");

                $.ajax({
                    url: "/Admin/AddPerson",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function (res) {
                        alert(res?.message || "Person added successfully.");
                        $("#addPersonModal").hide();
                        // reload to show the new person (keeps behavior consistent with other pages)
                        location.reload();
                    },
                    error: function (xhr) {
                        let message = "Failed to add person.";
                        try {
                            const json = xhr.responseJSON || JSON.parse(xhr.responseText || "{}");
                            if (json?.message) message = json.message;
                        } catch (e) { }
                        alert(message);
                    },
                    complete: function () {
                        $("#addNewPersonBtn").prop("disabled", false).text("Add");
                    }
                });
            });

            // Test notifications cho các nút hành động
            $("#searchBtn").click(function () {
                alert("Search button clicked (chưa có logic).");
            });
            $("#editBtn").click(function () {
                alert("Edit button clicked (chưa có logic).");
            });
            $("#deleteBtn").click(function () {
                alert("Delete button clicked (chưa có logic).");
            });
        });
    </script>
}


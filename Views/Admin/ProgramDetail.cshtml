@model SIMS.ViewModels.AcademicProgramDetailViewModel

@{
    Layout = "_AdminLayout";
}
<div style="margin-left:1vw;">
    <div class="actionBtnBox" style="margin-left: 1vh;">
        <h2>Program Detail</h2>
        <button id="filterCoursesInProgramBtn" type="button" class="btn btn-primary" style="margin-bottom: 1vh;">Filter Courses in this Program</button>
        <button id="addCourseToProgramBtn" class="btn btn-success" style="margin-bottom: 1vh;">Add a Course to the Program</button>
        <button id="editProgramInfoBtn" class="btn btn-warning" style="margin-bottom: 1vh;">Edit Program info</button>
        <button id="deleteProgramBtn" class="btn btn-danger" style="margin-bottom: 1vh;">Delete this Program</button>
        <hr />
    </div>

    <div style="max-width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fafafa;">
        <div id="programDetailBox">
            <p><b>Major:</b> @Model.AcademicProgram.Major?.MajorName</p>
            <p><b>Program Id:</b> @Model.AcademicProgram.AcademicProgramId</p>
            <p><b>Program Name:</b> @Model.AcademicProgram.AcademicProgramName</p>
            <p><b>Faculty in charge:</b> @Model.AcademicProgram.Faculty?.FacultyName</p>
            <p><b>Program Language:</b> @Model.AcademicProgram.Language</p>
            <p><b>Description:</b> @Model.AcademicProgram.Description</p>
            <p><b>Number of semesters:</b> @Model.AcademicProgram.NumberOfSemester</p>
            <p><b>Obligated credits:</b> @Model.AcademicProgram.ObligatedCredits</p>
            <p><b>Elective credits:</b> @Model.AcademicProgram.ElectiveCredits</p>
            <p><b>Total credits:</b> @Model.AcademicProgram.TotalOfRequiredCredits</p>
        </div>

    </div>

    <div style="max-width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fafafa;">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Semester</th>
                    <th>Course Name</th>
                    <th>Course Code</th>
                    <th>Credits</th>
                    <th>Is Elective</th>
                    <th title="Is Before Capstone Project">Is BCP</th>
                    <th title="Is Prerequisite Capstone Project">Is PCP</th>
                    <th>Previous</th>
                    <th>Parallel</th>
                    <th>Prerequisite</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int stt = 1;
                }
                @foreach (var c in Model.Curriculums)
                {
                    // find dependencies for this curriculum
                    var deps = Model.CourseDependencies?.Where(cd => cd.CurriculumId == c.CurriculumId).ToList() ?? new List<SIMS.Models.CourseDependency>();
                    var previousNames = deps.Where(d => d.PreviousCourse != null).Select(d => d.PreviousCourse.CourseName).Where(n => !string.IsNullOrEmpty(n)).Distinct();
                    var coreqNames = deps.Where(d => d.CorequisiteCourse != null).Select(d => d.CorequisiteCourse.CourseName).Where(n => !string.IsNullOrEmpty(n)).Distinct();
                    var prereqNames = deps.Where(d => d.PrerequisiteCourse != null).Select(d => d.PrerequisiteCourse.CourseName).Where(n => !string.IsNullOrEmpty(n)).Distinct();
                
                    <tr>
                        <td>@stt</td>
                        <td>1</td>
                        <td>@c.CourseId</td>
                        <td>@c.Course?.CourseName</td>
                        <td>@c.Course?.CourseCode</td>
                        <td>@c.Course?.TotalCredits</td>
                        @if (c.IsElective == true)
                        {
                            <td>✓</td>
                        }
                        else
                        {
                            <td></td>
                        }
                        @if (c.IsBeforeCapstoneProject == true)
                        {
                            <td>✓</td>
                        }
                        else
                        {
                            <td></td>
                        }
                        @if (c.IsPrerequisiteCapstoneProject == true)
                        {
                            <td>✓</td>
                        }
                        else
                        {
                            <td></td>
                        }
                        <td>@(previousNames.Any() ? string.Join(", ", previousNames) : "")</td>
                        <td>@(coreqNames.Any() ? string.Join(", ", coreqNames) : "")</td>
                        <td>@(prereqNames.Any() ? string.Join(", ", prereqNames) : "")</td>
                        <td>
                            <button class="btn btn-warning btn-sm view-details" data-id="">Edit</button>
                            <button class="btn btn-danger btn-sm view-details" data-id="">Delete</button>
                        </td>
                    </tr>
                    stt++;
                }
            </tbody>
        </table>
    </div>
</div>
@* Update Program Modal (similar behavior to Update Course modal) *@
<div id="updateProgramModal" class="user-modal" style="display:none;">
    <div class="user-modal-content">
        <span class="close-modal" id="closeUpdateProgramModal">&times;</span>
        <h3>Update Program</h3>
        <div class="row g-3" style="margin-top:12px;">
            <div class="col-md-4">
                <label for="updateProgramId" class="form-label">Program Id</label>
                <input type="text" class="form-control" id="updateProgramId" readonly value="@Model.AcademicProgram.AcademicProgramId" />
            </div>

            <div class="col-md-8">
                <label for="updateProgramName" class="form-label">Program Name</label>
                <input type="text" class="form-control" id="updateProgramName" value="@(Model.AcademicProgram.AcademicProgramName ?? "")" />
            </div>

            <div class="col-md-6">
                <label for="updateMajorName" class="form-label">Major</label>
                <input type="text" class="form-control" id="updateMajorName" list="majorList" value="@(Model.AcademicProgram.Major?.MajorName ?? "")" />
                <datalist id="majorList">
                    @{
                        var majors = Model.Majors;
                        if (majors != null)
                        {
                            foreach (var m in majors)
                            {
                                <option data-id="@m.MajorId" value="@m.MajorName"></option>
                            }
                        }
                    }
                </datalist>
                <input type="hidden" id="updateMajorId" value="@(Model.AcademicProgram.MajorId ?? 0)" />
            </div>

            <div class="col-md-6">
                <label for="updateFacultyName" class="form-label">Faculty in charge</label>
                <input type="text" class="form-control" id="updateFacultyName" list="facultyList" value="@(Model.AcademicProgram.Faculty?.FacultyName ?? "")" />
                <datalist id="facultyList">
                    @{
                        var faculties = Model.Faculties;
                        if (faculties != null)
                        {
                            foreach (var f in faculties)
                            {
                                <option data-id="@f.FacultyId" value="@f.FacultyName"></option>
                            }
                        }
                    }
                </datalist>
                <input type="hidden" id="updateFacultyId" value="@(Model.AcademicProgram.FacultyId ?? 0)" />
            </div>

            <div class="col-md-6">
                <label for="updateLanguage" class="form-label">Program Language</label>
                <input type="text" class="form-control" id="updateLanguage" value="@(Model.AcademicProgram.Language ?? "")" />
            </div>

            <div class="col-md-6">
                <label for="updateNumberOfSemester" class="form-label">Number of Semesters</label>
                <input type="number" class="form-control" id="updateNumberOfSemester" min="0" value="@(Model.AcademicProgram.NumberOfSemester ?? 0)" />
            </div>

            <div class="col-md-5">
                <label for="updateObligatedCredits" class="form-label">Obligated Credits</label>
                <input type="number" step="0.5" class="form-control" id="updateObligatedCredits" value="@(Model.AcademicProgram.ObligatedCredits ?? 0)" />
            </div>

            <div class="col-md-5">
                <label for="updateElectiveCredits" class="form-label">Elective Credits</label>
                <input type="number" step="0.5" class="form-control" id="updateElectiveCredits" value="@(Model.AcademicProgram.ElectiveCredits ?? 0)" />
            </div>
            <div class="col-md-2">
                <label for="updateTotalOfRequiredCredits" class="form-label">Total</label>
                <input type="number" class="form-control" id="updateTotalOfRequiredCredits" readonly value="@(Model.AcademicProgram.TotalOfRequiredCredits ?? 0)" />
            </div>

            <div class="col-md-12">
                <label for="updateDescription" class="form-label">Description</label>
                <textarea class="form-control" id="updateDescription">@Model.AcademicProgram.Description</textarea>
            </div>


            <div class="col-12" style="margin-top:20px;">
                <button id="updateProgramBtn" type="button" class="btn btn-warning">Update</button>
                <button id="cancelUpdateProgramBtn" type="button" class="btn btn-outline-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // Utility: find datalist option's data-id by value
            function datalistSelectedId(datalistSelector, value) {
                if (!value) return null;
                var found = $(datalistSelector + " option").filter(function () {
                    return $(this).val() === value;
                }).first();
                return found.length ? found.data("id") : null;
            }

            // Show update modal
            $('#editProgramInfoBtn').on('click', function () {
                // Show modal (inputs already populated server-side)
                $('#updateProgramModal').css('display', 'flex');

                // Ensure hidden ids reflect datalist selections if possible
                var majorVal = $('#updateMajorName').val()?.toString().trim() || '';
                var majorId = datalistSelectedId('#majorList', majorVal);
                if (majorId) $('#updateMajorId').val(majorId);

                var facultyVal = $('#updateFacultyName').val()?.toString().trim() || '';
                var facultyId = datalistSelectedId('#facultyList', facultyVal);
                if (facultyId) $('#updateFacultyId').val(facultyId);
            });

            // Thêm vào document.ready
            $('#updateMajorName').on('input change', function() {
                var val = $(this).val();
                var id = datalistSelectedId('#majorList', val);
                $('#updateMajorId').val(id || 0); // Đặt ID là 0 nếu không tìm thấy (hoặc null tùy logic backend)
            });

            $('#updateFacultyName').on('input change', function() {
                var val = $(this).val();
                var id = datalistSelectedId('#facultyList', val);
                $('#updateFacultyId').val(id || 0);
            });
            // Close handlers
            $('#closeUpdateProgramModal, #cancelUpdateProgramBtn').on('click', function () {
                $('#updateProgramModal').hide();
            });

            // Recompute total credits client-side when obligated/elective change
            function recomputeTotalCredits() {
                var obligated = parseFloat($('#updateObligatedCredits').val() || 0) || 0;
                var elective = parseFloat($('#updateElectiveCredits').val() || 0) || 0;
                $('#updateTotalOfRequiredCredits').val(obligated + elective);
            }
            $('#updateObligatedCredits, #updateElectiveCredits').on('input change', recomputeTotalCredits);

            // Simple client-side validation + enable Update button only when required fields are present
            function validateProgramModal() {
                var name = $('#updateProgramName').val()?.toString().trim() || '';
                return name.length > 0;
            }

            // Enable/disable update button based on validation
            $('#updateProgramModal input, #updateProgramModal textarea').on('input change', function () {
                $('#updateProgramBtn').prop('disabled', !validateProgramModal());
            });
            // initialize state
            $('#updateProgramBtn').prop('disabled', !validateProgramModal());

            // Update handler: send payload to server (adjust URL to match your controller action)
            $('#updateProgramBtn').on('click', function () {
                if (!validateProgramModal()) {
                    alert('Please enter a valid Program Name.');
                    return;
                }

                var payload = {
                    academicProgramId: parseInt($('#updateProgramId').val() || 0),
                    academicProgramName: $('#updateProgramName').val()?.toString().trim() || '',
                    majorId: parseInt($('#updateMajorId').val() || 0) || null,
                    facultyId: parseInt($('#updateFacultyId').val() || 0) || null,
                    language: $('#updateLanguage').val()?.toString().trim() || '',
                    description: $('#updateDescription').val()?.toString().trim() || '',
                    numberOfSemester: parseInt($('#updateNumberOfSemester').val() || 0) || null,
                    obligatedCredits: parseFloat($('#updateObligatedCredits').val() || 0) || null,
                    electiveCredits: parseFloat($('#updateElectiveCredits').val() || 0) || null
                };

                // Disable button while request in-flight
                $('#updateProgramBtn').prop('disabled', true).text('Updating...');

                // NOTE: adjust the URL to the correct action in your app that accepts this payload.
                $.ajax({
                    url: '/AcademicProgram/UpdateAcademicProgram',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (res) {
                        // Expecting { success: true } or similar. Adapt to your API response.
                        if (res && res.success) {
                            // update the programDetailBox quickly on client to reflect changes
                            if (payload.majorId && $('#majorList option[data-id="' + payload.majorId + '"]').length) {
                                var majName = $('#majorList option[data-id="' + payload.majorId + '"]').val();
                                $('div#programDetailBox p:contains("Major:")').html('<b>Major:</b> ' + majName);
                            } else {
                                $('div#programDetailBox p:contains("Major:")').html('<b>Major:</b> ' + ($('#updateMajorName').val() || ''));
                            }
                            $('div#programDetailBox p:contains("Program Name:")').html('<b>Program Name:</b> ' + payload.academicProgramName);
                            $('div#programDetailBox p:contains("Program Language:")').html('<b>Program Language:</b> ' + payload.language);
                            $('div#programDetailBox p:contains("Description:")').html('<b>Description:</b> ' + payload.description);
                            $('div#programDetailBox p:contains("Number of semesters:")').html('<b>Number of semesters:</b> ' + (payload.numberOfSemester ?? ''));
                            $('div#programDetailBox p:contains("Obligated credits:")').html('<b>Obligated credits:</b> ' + (payload.obligatedCredits ?? ''));
                            $('div#programDetailBox p:contains("Elective credits:")').html('<b>Elective credits:</b> ' + (payload.electiveCredits ?? ''));
                            var total = (payload.obligatedCredits || 0) + (payload.electiveCredits || 0);
                            $('div#programDetailBox p:contains("Total credits:")').html('<b>Total credits:</b> ' + total);
                            $('#updateProgramModal').hide();
                            alert(res.message || 'Program updated successfully.');
                        } else {
                            var msg = (res && res.message) ? res.message : 'Failed to update program.';
                            alert(msg);
                        }
                    },
                    error: function () {
                        alert('Server error while updating program. Please try again later.');
                    },
                    complete: function () {
                        $('#updateProgramBtn').prop('disabled', false).text('Update');
                    }
                });
            });

            $('#deleteProgramBtn').on('click', function () {
                if (!confirm('Are you sure you want to delete this program? This action cannot be undone.')) {
                    return;
                }
                var $btn = $(this);
                var programId = @(Model.AcademicProgram.AcademicProgramId);
                $btn.prop('disabled', true).text('Deleting...');

                $.ajax({
                    url: '/AcademicProgram/DeleteAcademicProgram',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(programId),
                    success: function (res) {
                        if (res && res.success) {
                            alert('Program deleted successfully.');
                            window.location.href = '/AcademicProgram/AcademicProgram';
                        } else {
                            var msg = (res && res.message) ? res.message : 'Failed to delete program.';
                            alert(msg);
                        }
                    },
                    error: function (xhr) {
                        var parsed = null;
                        try { parsed = JSON.parse(xhr.responseText || "{}"); } catch { }
                        var msg = (parsed && parsed.message) ? parsed.message : 'Server error while deleting program.';
                        alert(msg);
                    },
                    complete: function () {
                        $btn.prop('disabled', false).text('Delete this Program');
                    }
                });
            });

            // Close modal when clicking outside the content
            $(document).on('click', '#updateProgramModal', function (e) {
                if (e.target === this) $(this).hide();
            });
        });
    </script>
}
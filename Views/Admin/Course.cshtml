@model List<SIMS.Models.Course>

@{
    Layout = "_AdminLayout";
}

<h2>Courses List</h2>
<div class="actionBtnBox">
    <form></form>
    <button id="searchCourseBtn" type="button" class="btn btn-primary" style="margin-bottom: 1vh;">Search</button>
    <button id="filterBtn" type="button" class="btn btn-secondary" style="margin-bottom: 1vh;">Filter</button>
    <button id="addCourseBtn" type="button" class="btn btn-success" style="margin-bottom: 1vh;">Add</button>
    <button id="editCourseBtn" type="button" class="btn btn-warning" style="margin-bottom: 1vh;">Edit</button>
    <button id="deleteCourseBtn" type="button" class="btn btn-danger" style="margin-bottom: 1vh;">Delete</button>
</div>

<div style="max-width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fafafa;">

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Action</th>
                <th>STT</th>
                <th>Course ID</th>
                <th>Course Code</th>
                <th>Course Name</th>
                <th>Faculty in charge</th>
                <th>Total Credits</th>
                <th>Lecture Credits</th>
                <th>Practical Credits</th>
                <th>Internship Credits</th>
                <th>Capstone Credits</th>
                <th>Summary</th>
            </tr>
        </thead>
        <tbody>
            @{
                int stt = 1;
            }
            @foreach (var c in Model)
            {
                <tr>
                    <td>
                        <button class="btn btn-info btn-sm view-details" data-id="@c.CourseId">View</button>
                    </td>
                    <td>@stt</td>
                    <td>@c.CourseId</td>
                    <td>
                        <a href="#" class="view-details" data-id="@c.CourseId">
                            @(c.CourseCode ?? "N/A")
                        </a>
                    </td>
                    <td>@c.CourseName</td>
                    <td>@(c.Faculty?.FacultyName ?? (c.FacultyId?.ToString() ?? "N/A"))</td>
                    <td>
                        @(
                            c.TotalCredits.HasValue
                                ? c.TotalCredits.Value.ToString()
                                : ((c.LectureCredits ?? 0m) + (c.PracticalCredits ?? 0m) + (c.InternshipCredits ?? 0m) + (c.CapstoneCredits ?? 0m)).ToString()
                        )
                    </td>
                    <td>@c.LectureCredits</td>
                    <td>@c.PracticalCredits</td>
                    <td>@c.InternshipCredits</td>
                    <td>@c.CapstoneCredits</td>
                    <td>@c.CourseSummary</td>
                </tr>
                 stt++;
            }

        </tbody>
    </table>

</div>

@* Filter Modal *@
<div id="filterModal" class="user-modal">
    <div class="user-modal-content">
        <span class="close-modal" id="closeFilterModal">&times;</span>
        <h3>Filter Courses</h3>
        <div class="row g-3" style="margin-top:12px;">
            <div class="col-md-6">
                <label for="filterName" class="form-label">Course name contains</label>
                <input type="text" class="form-control" id="filterName" />
            </div>
            <div class="col-md-6">
                <label for="filterCode" class="form-label">Course code contains</label>
                <input type="text" class="form-control" id="filterCode" />
            </div>

            <div class="col-md-6">
                <label for="filterFacultyId" class="form-label">Faculty in charge</label>
                <select id="filterFacultyId" class="form-select">
                    <option value="">Any</option>
                    @{
                        var faculties = ViewBag.Faculties as List<Faculty>;
                        if (faculties != null)
                        {
                            foreach (var f in faculties)
                            {
                                <option value="@f.FacultyId">@f.FacultyName</option>
                            }
                        }
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Lecture Credits (min)</label>
                <input type="number" step="0.5" min="0" id="filterLectureMin" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Lecture Credits (max)</label>
                <input type="number" step="0.5" min="0" id="filterLectureMax" class="form-control" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Practical Credits (min)</label>
                <input type="number" step="0.5" min="0" id="filterPracticalMin" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Practical Credits (max)</label>
                <input type="number" step="0.5" min="0" id="filterPracticalMax" class="form-control" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Internship Credits (min)</label>
                <input type="number" step="0.5" min="0" id="filterInternshipMin" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Internship Credits (max)</label>
                <input type="number" step="0.5" min="0" id="filterInternshipMax" class="form-control" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Capstone Credits (min)</label>
                <input type="number" step="0.5" min="0" id="filterCapstoneMin" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Capstone Credits (max)</label>
                <input type="number" step="0.5" min="0" id="filterCapstoneMax" class="form-control" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Total Credits (min)</label>
                <input type="number" step="0.5" min="0" id="filterTotalMin" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Total Credits (max)</label>
                <input type="number" step="0.5" min="0" id="filterTotalMax" class="form-control" />
            </div>

            <div class="col-md-12">
                <label for="filterSummary" class="form-label">Course summary contains</label>
                <input type="text" class="form-control" id="filterSummary" />
            </div>

            <div class="col-12" style="margin-top:8px;">
                <button id="applyFilterBtn" type="button" class="btn btn-primary">Apply</button>
                <button id="clearFilterBtn" type="button" class="btn btn-outline-secondary">Clear</button>
            </div>
        </div>
    </div>
</div>

<!-- Course Details Modal -->
<div class="modal fade" id="courseDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Course Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="course-details-loading" style="text-align:center; padding:20px;">
                    Loading...
                </div>

                <div id="course-details-content" style="display:none;">
                    <p><strong>Course ID:</strong> <span id="detail-course-id"></span></p>
                    <p><strong>Code:</strong> <span id="detail-course-code"></span></p>
                    <p><strong>Name:</strong> <span id="detail-course-name"></span></p>
                    <p><strong>Faculty in charge:</strong> <span id="detail-faculty-id"></span></p>
                    <p><strong>Total Credits:</strong> <span id="detail-total-credits"></span></p>
                    <p><strong>Lecture:</strong> <span id="detail-lecture-credits"></span></p>
                    <p><strong>Practical:</strong> <span id="detail-practical-credits"></span></p>
                    <p><strong>Internship:</strong> <span id="detail-internship-credits"></span></p>
                    <p><strong>Capstone:</strong> <span id="detail-capstone-credits"></span></p>
                    <p><strong>Summary:</strong> <span id="detail-summary"></span></p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Khi người dùng chọn một option từ datalist
        $("#facultyInCharge").on("input change", function () {
            const inputVal = $(this).val().trim();
            let selectedFacultyId = "";

            // Duyệt qua tất cả option trong datalist để tìm tên khớp
            $("#facultyInChargeList option").each(function () {
                if ($(this).val() === inputVal) {
                    selectedFacultyId = $(this).data("id");
                    return false; // break
                }
            });

            $("#facultyId").val(selectedFacultyId || ""); // nếu không tìm thấy thì để trống
        });

        // Trường hợp người dùng xóa hết hoặc nhập tay không khớp → reset facultyId
        $("#facultyInCharge").on("blur", function () {
            const val = $(this).val().trim();
            let found = false;
            $("#facultyInChargeList option").each(function () {
                if ($(this).val() === val) {
                    found = true;
                    return false;
                }
            });
            if (!found) {
                $("#facultyId").val("");
            }
        });

        $(document).ready(function() {

            // Hide any traditional pagination if present (we rely on infinite scroll)
            $(".pagination").hide();

            // Filter modal open/close
            $("#filterBtn").on("click", function() {
                $("#filterModal").css("display", "flex");
            });
            $("#closeFilterModal").on("click", function() {
                $("#filterModal").hide();
            });
            // Close when clicking outside content
            $("#filterModal").on("click", function(e) {
                if (e.target === this) {
                    $(this).hide();
                }
            });

            // Filter handlers
            $("#applyFilterBtn").on("click", function() {
                const name = $("#filterName").val()?.toString().trim();
                const code = $("#filterCode").val()?.toString().trim();
                const facultyId = $("#filterFacultyId").val();
                const summary = $("#filterSummary").val()?.toString().trim();

                // Build filters object only including non-empty values so model binding of nullable types works
                filters = {};
                if (name) filters.name = name;
                if (code) filters.code = code;
                if (facultyId) {
                    if (facultyId !== "") filters.facultyId = facultyId;
                }
                if (summary) filters.summary = summary;

                const lectureMin = $("#filterLectureMin").val();
                const lectureMax = $("#filterLectureMax").val();
                if (lectureMin !== "") filters.lectureMin = lectureMin;
                if (lectureMax !== "") filters.lectureMax = lectureMax;

                const practicalMin = $("#filterPracticalMin").val();
                const practicalMax = $("#filterPracticalMax").val();
                if (practicalMin !== "") filters.practicalMin = practicalMin;
                if (practicalMax !== "") filters.practicalMax = practicalMax;

                const internshipMin = $("#filterInternshipMin").val();
                const internshipMax = $("#filterInternshipMax").val();
                if (internshipMin !== "") filters.internshipMin = internshipMin;
                if (internshipMax !== "") filters.internshipMax = internshipMax;

                const capstoneMin = $("#filterCapstoneMin").val();
                const capstoneMax = $("#filterCapstoneMax").val();
                if (capstoneMin !== "") filters.capstoneMin = capstoneMin;
                if (capstoneMax !== "") filters.capstoneMax = capstoneMax;

                const totalMin = $("#filterTotalMin").val();
                const totalMax = $("#filterTotalMax").val();
                if (totalMin !== "") filters.totalMin = totalMin;
                if (totalMax !== "") filters.totalMax = totalMax;

                // Toggle filter indicator (red dot) if any filter is set
                const anyFilter = Object.keys(filters).length > 0;
                if (anyFilter) {
                    $("#filterBtn").addClass("has-active-filters");
                } else {
                    $("#filterBtn").removeClass("has-active-filters");
                }

                $("#filterModal").hide();

                // Reset and load with new filters
                resetAndLoad();
            });

            $("#clearFilterBtn").on("click", function() {
                $("#filterName").val("");
                $("#filterCode").val("");
                $("#filterFacultyId").val("");
                $("#filterSummary").val("");

                $("#filterLectureMin, #filterLectureMax, #filterPracticalMin, #filterPracticalMax, #filterInternshipMin, #filterInternshipMax, #filterCapstoneMin, #filterCapstoneMax, #filterTotalMin, #filterTotalMax").val("");

                filters = {};
                $("#filterBtn").removeClass("has-active-filters");
                resetAndLoad();
            });

            // Xử lý hiện/ẩn Add Course Modal
            $("#addCourseBtn").on("click", function() {
                $("#addCourseModal").css("display", "flex");
            });
            $("#closeAddCourseModal").on("click", function() {
                $("#addCourseModal").hide();
            });
            $("#addCourseModal").on("click", function(e) {
                if (e.target === this) {
                    $(this).hide();
                }
            });

            // Update total credits whenever credit fields change
            function updateTotalCredits() {
                const lecture = parseFloat($("#lectureCredits").val() || 0) || 0;
                const practical = parseFloat($("#practicalCredits").val() || 0) || 0;
                const internship = parseFloat($("#internshipCredits").val() || 0) || 0;
                const capstone = parseFloat($("#capstoneCredits").val() || 0) || 0;
                const total = lecture + practical + capstone;
                $("#totalCredits").val(total);
            }
            $("#lectureCredits, #practicalCredits, #internshipCredits, #capstoneCredits").on("input change", updateTotalCredits);

            // Add new course handler
            $("#addNewCourseBtn").on("click", function () {
                
                // Gọi hàm cập nhật tổng tín chỉ trước khi gửi
                updateTotalCredits();
                // client-side validation
                const courseName = $("#courseName").val()?.toString().trim() || "";
                const tenHocPhan = $("#tenHocPhan").val()?.toString().trim() || "";
                const courseCode = $("#courseCode").val()?.toString().trim() || "";
                const faculty = $("#facultyInCharge").val()?.toString().trim() || "";
                const facultyId = $("#facultyId").val()?.toString().trim() || "";


                const lecture = parseFloat($("#lectureCredits").val() || 0) || 0;
                const practical = parseFloat($("#practicalCredits").val() || 0) || 0;
                const internship = parseFloat($("#internshipCredits").val() || 0) || 0;
                const capstone = parseFloat($("#capstoneCredits").val() || 0) || 0;
                // const totalCredits = parseFloat($("#totalCredits").val() || 0) || 0;
                const summary = $("#courseSummary").val()?.toString().trim() || "";

                
                if (!courseName) {
                    alert("Course name is required.");
                    return;
                }
                if (!/^\d{7}$/.test(courseCode)) {
                    alert("Course code is required and must be exactly 7 digits.");
                    return;
                }
                if (lecture < 0 || practical < 0 || internship < 0 || capstone < 0) {
                    alert("Credit values must be 0 or positive.");
                    return;
                }

                const payload = {
                    courseName: courseName,
                    tenHocPhan: tenHocPhan,
                    courseCode: courseCode,
                    facultyId: $("#facultyId").val() || null,
                    lectureCredits: lecture,
                    practicalCredits: practical,
                    internshipCredits: internship,
                    capstoneCredits: capstone,
                    courseSummary: summary
                };

                // disable button while submitting
                $("#addNewCourseBtn").prop("disabled", true).text("Adding...");

                $.ajax({
                    url: "/Admin/AddCourse",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function (res) {
                        alert(res?.message || "Course added successfully.");
                        $("#addCourseModal").hide();
                        // reset form
                        $("#courseName, #tenHocPhan, #courseCode, #facultyInCharge, #lectureCredits, #practicalCredits, #internshipCredits, #capstoneCredits, #courseSummary").val("");
                        $("#totalCredits").val("");
                        // refresh list to show newly added course: clear and reload
                        resetAndLoad();
                    },
                    error: function (xhr) {
                        let message = "Failed to add course.";
                        try {
                            const json = JSON.parse(xhr.responseText || "{}");
                            if (json?.message) message = json.message;
                        } catch (e) {
                            // ignore parse error
                        }
                        alert(message);
                    },
                    complete: function () {
                        $("#addNewCourseBtn").prop("disabled", false).text("Add");
                    }
                });
            });

            // Infinite scroll and filter setup
            // Render server values as numeric literals
            let currentPage = @(ViewBag.Page ?? 1);
            let totalPages = @(ViewBag.TotalPages ?? 1);
            let isLoading = false;
            // Start STT counter at number of rows already rendered by server (Model.Count)
            let sttCounter = @(Model.Count);
            let filters = {}; // Global filters object

            console.log("Infinite scroll state on load:", { currentPage, totalPages, sttCounter });

            // If the page doesn't have enough content (no scrollbar), auto-load until full or out of pages
            function autoFillIfNeeded() {
                if ($(document).height() <= $(window).height() && currentPage < totalPages) {
                    console.log("Auto-loading next page because content is short.");
                    loadMoreCourses();
                }
            }

            // Function to reset table and reload data
            function resetAndLoad() {
                $("tbody").empty();
                sttCounter = 0;
                currentPage = 0;
                totalPages = 1; // Reset to trigger load
                loadMoreCourses();
            }

            // View details handler
            $(document).on("click", ".view-details", function (e) {
                e.preventDefault();
                const id = $(this).data("id");

                // Reset state
                $("#course-details-loading").show();
                $("#course-details-content").hide();

                // Open modal
                const modal = new bootstrap.Modal(document.getElementById("courseDetailsModal"));
                modal.show();

                // AJAX to get data
                $.ajax({
                    url: "/Admin/GetCourseDetails",
                    method: "GET",
                    data: { id: id },
                    success: function (c) {
                        $("#course-details-loading").hide();
                        $("#course-details-content").show();

                        $("#detail-course-id").text(c.courseId);
                        $("#detail-course-code").text(c.courseCode);
                        $("#detail-course-name").text(c.courseName);
                        $("#detail-faculty-id").text(c.facultyId);
                        $("#detail-total-credits").text(c.totalCredits);
                        $("#detail-lecture-credits").text(c.lectureCredits);
                        $("#detail-practical-credits").text(c.practicalCredits);
                        $("#detail-internship-credits").text(c.internshipCredits);
                        $("#detail-capstone-credits").text(c.capstoneCredits);
                        $("#detail-summary").text(c.courseSummary);
                    },
                    error: function () {
                        $("#course-details-loading").text("Failed to load data.");
                    }
                });
            });

            // Load more courses function
            function loadMoreCourses() {
                if (isLoading) {
                    console.log("Skipped loadMoreCourses() because already loading.");
                    return;
                }
                if (currentPage >= totalPages) {
                    console.log("No more pages to load. currentPage:", currentPage, "totalPages:", totalPages);
                    return;
                }

                isLoading = true;
                currentPage++;

                console.log("Requesting page", currentPage, "with filters", filters);

                $.ajax({
                    url: "/Admin/GetCourses",
                    method: "GET",
                    data: Object.assign({ page: currentPage }, filters),
                    success: function (data) {
                        console.log("GetCourses success for page", currentPage, data);
                        if (data.courses && data.courses.length > 0) {
                            data.courses.forEach(function(c) {
                                sttCounter++;
                                let row = `
                                    <tr>
                                        <td>
                                            <button class="btn btn-info btn-sm view-details" data-id="${c.courseId}">View</button>
                                        </td>
                                        <td>${sttCounter}</td>
                                        <td>${c.courseId}</td>
                                        <td>
                                            <a href="#" class="view-details" data-id="${c.courseId}">
                                                ${c.courseCode || "N/A"}
                                            </a>
                                        </td>
                                        <td>${c.courseName || ""}</td>
                                        <td>${c.facultyName || (c.facultyId ?? "N/A")}</td>
                                        <td>${c.totalCredits ?? 0}</td>
                                        <td>${c.lectureCredits ?? 0}</td>
                                        <td>${c.practicalCredits ?? 0}</td>
                                        <td>${c.internshipCredits ?? 0}</td>
                                        <td>${c.capstoneCredits ?? 0}</td>
                                        <td>${c.courseSummary ?? ""}</td>
                                    </tr>
                                `;
                                $("tbody").append(row);
                            });

                            totalPages = data.totalPages || totalPages;
                            console.log("Updated totalPages:", totalPages);
                        } else {
                            console.log("No more courses in response for page", currentPage);
                        }
                        isLoading = false;

                        // If page still short after appending, try loading next automatically
                        autoFillIfNeeded();
                    },
                    error: function (xhr, status, err) {
                        console.error("Error loading more courses", status, err, xhr);
                        isLoading = false;
                    }
                });
            }

            // Scroll event listener (throttle basic)
            let scrollTimer = null;
            $(window).on('scroll', function() {
                if (scrollTimer) return;
                scrollTimer = setTimeout(function() {
                    scrollTimer = null;
                    if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                        loadMoreCourses();
                    }
                }, 150);
            });

            // Initial check: if first page already rendered, try to auto-fill if not enough content
            autoFillIfNeeded();
        });

        // Validation helpers for credit range pairs
function parseNullableNumber(selector) {
    const v = $(selector).val();
    if (v === "" || v === null || v === undefined) return null;
    const n = parseFloat(v);
    return isNaN(n) ? null : n;
}
function setFieldError($el, message) {
    $el.addClass("is-invalid");
    let $fb = $el.next(".invalid-feedback");
    if (!$fb.length) {
        $fb = $('<div class="invalid-feedback"></div>').insertAfter($el);
    }
    $fb.text(message);
}
function clearFieldError($el) {
    $el.removeClass("is-invalid");
    const $fb = $el.next(".invalid-feedback");
    if ($fb.length) $fb.remove();
}
function validateRangePair(minSelector, maxSelector, label) {
    const $min = $(minSelector), $max = $(maxSelector);
    clearFieldError($min); clearFieldError($max);
    const min = parseNullableNumber(minSelector);
    const max = parseNullableNumber(maxSelector);
    if (min !== null && max !== null && min > max) {
        setFieldError($min, label + " min must be less than or equal to max.");
        setFieldError($max, "");
        return false;
    }
    return true;
}
// Wire up real-time validation for each pair
["Lecture","Practical","Internship","Capstone","Total"].forEach(function(prefix) {
    const minSel = "#filter" + prefix + "Min";
    const maxSel = "#filter" + prefix + "Max";
    $(minSel + "," + maxSel).on("input change", function() {
        validateRangePair(minSel, maxSel, prefix + " credits");
    });
});

// Replace / augment apply handler: validate before building filters
// (If your file already defines this handler, replace that block with the one below.)
$("#applyFilterBtn").off("click").on("click", function() {
    // Validate all pairs first
    const pairsValid =
        validateRangePair("#filterLectureMin", "#filterLectureMax", "Lecture")
        & validateRangePair("#filterPracticalMin", "#filterPracticalMax", "Practical")
        & validateRangePair("#filterInternshipMin", "#filterInternshipMax", "Internship")
        & validateRangePair("#filterCapstoneMin", "#filterCapstoneMax", "Capstone")
        & validateRangePair("#filterTotalMin", "#filterTotalMax", "Total");
    if (!pairsValid) {
        // Focus first invalid input
        const $firstInvalid = $(".is-invalid").first();
        if ($firstInvalid.length) $firstInvalid.focus();
        return; // stop - do not apply filters
    }

    // Existing filter build logic (unchanged)
    const name = $("#filterName").val()?.toString().trim();
    const code = $("#filterCode").val()?.toString().trim();
    const facultyId = $("#filterFacultyId").val();
    const summary = $("#filterSummary").val()?.toString().trim();

    filters = {};
    if (name) filters.name = name;
    if (code) filters.code = code;
    if (facultyId) { if (facultyId !== "") filters.facultyId = facultyId; }
    if (summary) filters.summary = summary;

    const lectureMin = $("#filterLectureMin").val();
    const lectureMax = $("#filterLectureMax").val();
    if (lectureMin !== "") filters.lectureMin = lectureMin;
    if (lectureMax !== "") filters.lectureMax = lectureMax;

    const practicalMin = $("#filterPracticalMin").val();
    const practicalMax = $("#filterPracticalMax").val();
    if (practicalMin !== "") filters.practicalMin = practicalMin;
    if (practicalMax !== "") filters.practicalMax = practicalMax;

    const internshipMin = $("#filterInternshipMin").val();
    const internshipMax = $("#filterInternshipMax").val();
    if (internshipMin !== "") filters.internshipMin = internshipMin;
    if (internshipMax !== "") filters.internshipMax = internshipMax;

    const capstoneMin = $("#filterCapstoneMin").val();
    const capstoneMax = $("#filterCapstoneMax").val();
    if (capstoneMin !== "") filters.capstoneMin = capstoneMin;
    if (capstoneMax !== "") filters.capstoneMax = capstoneMax;

    const totalMin = $("#filterTotalMin").val();
    const totalMax = $("#filterTotalMax").val();
    if (totalMin !== "") filters.totalMin = totalMin;
    if (totalMax !== "") filters.totalMax = totalMax;

    const anyFilter = Object.keys(filters).length > 0;
    if (anyFilter) $("#filterBtn").addClass("has-active-filters"); else $("#filterBtn").removeClass("has-active-filters");

    $("#filterModal").hide();
    resetAndLoad();
});
@model SIMS.ViewModels.AcademicProgramViewModel

@{
    Layout = "_AdminLayout";
}

<div style="margin-left:1vw;">
    <div class="actionBtnBox">
        <h2>Academic Programs</h2>
        <button id="filterProgramsBtn" type="button" class="btn btn-primary" style="margin-bottom: 1vh;">Filter Academic Programs</button>
        <button id="addProgramBtn" class="btn btn-success" style="margin-bottom: 1vh;">Add a New Academic Programs</button>
        <hr />
    </div>

    <div style="max-width: 100%; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fafafa;">

        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Action</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Major</th>
                    <th>Faculty</th>
                    <th>Language</th>
                    <th>Description</th>
                    <th>Number of Semesters</th>
                    <th>Total</th>
                    <th>Obligated Credits</th>
                    <th>Elective Credits</th>
                    @* <th>Created At</th> *@
                    @* <th>Updated At</th> *@
                    @* <th>Is Deleted</th> *@
                </tr>
            </thead>
            <tbody>
                @foreach (var p in Model.AcademicPrograms)
                {
                    <tr>
                        <td>
                            <button class="btn btn-info btn-sm view-details" data-id="@p.AcademicProgramId">View</button>
                        </td>
                        <td>@p.AcademicProgramId</td>
                        <td>
                            <a href="@Url.Action("ProgramDetail","ProgramDetail", new { id = p.AcademicProgramId })" class="view-details" data-id="@p.AcademicProgramId">
                                @(p.AcademicProgramName ?? "N/A")
                            </a>
                        </td>

                        <td>
                            @if (p.Major == null || string.IsNullOrEmpty(p.Major.MajorName))
                            {
                                @Html.Raw("<em>Not set yet</em>")
                            }
                            else
                            {
                                @p.Major.MajorName
                            }
                        </td>

                        <td>
                            @if (p.Faculty == null || string.IsNullOrEmpty(p.Faculty.FacultyName))
                            {
                                @Html.Raw("<em>Not set yet</em>")
                            }
                            else
                            {
                                @p.Faculty.FacultyName
                            }
                        </td>

                        <td>@(p.Language ?? "N/A")</td>
                        <td>@(string.IsNullOrEmpty(p.Description) ? @Html.Raw("<em>Not set yet</em>") : (p.Description.Length > 50 ? p.Description.Substring(0, 50) + "..." : p.Description))</td>
                        <td>@p.NumberOfSemester</td>
                        <td>@p.TotalOfRequiredCredits</td>
                        <td>@p.ObligatedCredits</td>
                        <td>@p.ElectiveCredits</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
@* Add New Program Modal*@
<div id="addProgramModal" class="user-modal">
    <div class="user-modal-content">
        <span class="close-modal" id="closeAddProgramModal">&times;</span>
        <h3>Add New Program</h3>
        <div class="row g-3" style="margin-top:12px;">
            <div class="col-md-6">
                <label for="programName" class="form-label">Program Name</label>
                <input type="text"
                       class="form-control"
                       id="programName"
                       placeholder="a program name" />
            </div>

            <div class="col-md-6">
                <label for="major" class="form-label">Major</label>
                <input type="text"
                       class="form-control"
                       id="major"
                       list="majorList" />
                <datalist id="majorList">
                    @{
                        var majors = Model.Majors;
                        foreach (var m in majors)
                        {
                            <option data-id="@m.MajorId" value="@m.MajorName">@m.TenNganh</option>
                        }
                    }
                    <input type="hidden" id="majorId" name="majorId" value="" />
                </datalist>
            </div>

            <div class="col-md-6">
                <label for="faculty" class="form-label">Faculty in charge</label>
                <input type="text"
                       class="form-control"
                       id="faculty"
                       list="facultyList" />
                <datalist id="facultyList">
                    @{
                        var faculties = Model.Faculties;
                        foreach (var f in faculties)
                        {
                            <option data-id="@f.FacultyId" value="@f.FacultyName">@f.TenKhoa</option>
                        }
                    }
                    <input type="hidden" id="facultyId" name="facultyId" value="" />
                </datalist>
            </div>

            <div class="col-md-6">
                <label for="language" class="form-label">Language</label>
                <input type="text"
                       class="form-control"
                       id="language"
                       placeholder="e.g., Vietnamese" />
            </div>
            <div class="col-md-6">
                <label for="description" class="form-label">Description</label>
                <input type="text"
                       class="form-control"
                       id="description"
                       placeholder="a meaningful description" />
            </div>
            <div class="col-md-6">
                <label for="numberOfSemesters" class="form-label">Number of semesters</label>
                <input type="text"
                       class="form-control"
                       id="numberOfSemesters"
                       required
                       placeholder="a positve integer required" />
            </div>

            <div class="col-md-5">
                <label for="obligatedCredits" class="form-label">Obligated Credits</label>
                <input type="number"
                       class="form-control"
                       id="obligatedCredits"
                       placeholder="a positive number required"
                       value="0"
                       min="0"
                       step="0.5" />
            </div>

            <div class="col-md-5">
                <label for="internshipCredits" class="form-label">Elective Credits</label>
                <input type="number"
                       class="form-control"
                       id="internshipCredits"
                       placeholder="a positive number required"
                       value="0"
                       min="0"
                       step="0.5" />
            </div>

            <div class="col-md-2">
                <label for="totalCredits" class="form-label">Total Credits</label>
                <input type="number"
                       class="form-control"
                       id="totalCredits"
                       readonly
                       placeholder="Readonly field" />
            </div>

            <div class="col-12" style="margin-top:20px;">
                <button id="addNewProgramBtn" type="button" class="btn btn-success">Add</button>
                <button id="cancelAddNewProgramBtn" type="button" class="btn btn-outline-danger">Cancel</button>
            </div>
        </div>
    </div>
</div>

@* Filter Modal *@
<div id="filterModal" class="user-modal">
    <div class="user-modal-content">
        <span class="close-modal" id="closeFilterModal">&times;</span>
        <h3>Filter Programs</h3>
        <div class="row g-3" style="margin-top:12px;">

            <div class="col-md-8">
                <label for="filterProgramName" class="form-label">Program name contains</label>
                <input type="text" class="form-control" id="filterProgramName" />
            </div>
            <div class="col-md-4">
                <label for="filterNumberOfSemesters" class="form-label">Number of semester</label>
                <input type="number" step="1" min="0" class="form-control" id="filterNumberOfSemesters" />
            </div>
            <div class="col-md-6">
                <label for="filterMajorInProgram" class="form-label">Major</label>
                <select class="form-select" id="filterMajorInProgram">
                    <option value="">Any</option>
                    @{
                        if (majors != null)
                        {
                            foreach (var m in majors)
                            {
                                <option value="@m.MajorId">@m.MajorName</option>
                            }
                        }
                    }
                </select>
            </div>

            <div class="col-md-6">
                <label for="filterFacultyInCharge" class="form-label">Faculty in charge</label>
                <select class="form-select" id="filterFacultyInCharge">
                    <option value="">Any</option>
                    @{
                        if (faculties != null)
                        {
                            foreach (var f in faculties)
                            {
                                <option value="@f.FacultyId">@f.FacultyName</option>
                            }
                        }
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label for="filterLanguage" class="form-label">Language</label>
                <input type="text" class="form-control" id="filterLanguage" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Obligated Credits (min)</label>
                <input type="number" step="0.5" min="0" class="form-control" id="filterObligatedMin" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Obligated Credits (max)</label>
                <input type="number" step="0.5" min="0" class="form-control" id="filterObligatedMax" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Elective Credits (min)</label>
                <input type="number" step="0.5" min="0" class="form-control" id="filterElectiveMin" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Elective Credits (max)</label>
                <input type="number" step="0.5" min="0" class="form-control" id="filterElectiveMax" />
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Total Credits (min)</label>
                <input type="number" step="0.5" min="0" class="form-control" id="filterTotalMin" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Total Credits (max)</label>
                <input type="number" step="0.5" min="0" class="form-control" id="filterTotalMax" />
            </div>

            <div class="col-md-12">
                <label for="filterDescription" class="form-label">Description</label>
                <input type="text" class="form-control" id="filterDescription" />
            </div>

            <div class="col-12" style="margin-top:20px;">
                <button id="applyFilterBtn" type="button" class="btn btn-primary">Apply</button>
                <button id="clearFilterBtn" type="button" class="btn btn-outline-secondary">Clear</button>
            </div>

        </div>

    </div>

</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // base URL for program detail (without query)
            const programDetailBase = '@Url.Action("ProgramDetail","ProgramDetail")';
            
            // open program detail when clicking view-details (links already have href)
            $(document).on('click', '.view-details', function (e) {
                // if anchor (<a>) was clicked, allow normal navigation
                const tag = e.target.tagName?.toLowerCase();
                if (tag === 'a') {
                    // anchor already points to ProgramDetail via href; allow navigation
                    return;
                }
                // else handle button case: navigate to detail
                e.preventDefault();
                const id = $(this).data('id');
                if (!id) return;
                window.location.href = programDetailBase + '?id=' + encodeURIComponent(id);
            });

            // modal open/close
            $("#addProgramBtn").on("click", function () { $("#addProgramModal").css("display", "flex"); });
            $("#closeAddProgramModal, #cancelAddNewProgramBtn").on("click", function () { $("#addProgramModal").hide(); });
            $("#addProgramModal").on("click", function (e) { if (e.target === this) $(this).hide(); });

            $("#filterProgramsBtn").on("click", function() { $("#filterModal").css("display", "flex"); });
            $("#closeFilterModal").on("click", function() { $("#filterModal").hide(); });
            $("#filterModal").on("click", function(e) { if (e.target === this) $(this).hide(); });

            // $(".view-details").click(function(e) {
            //     e.preventDefault();
            //     const programId = $(this).data("id");
            //     console.log("View program:", programId);
            //     alert("View program details for ID: " + programId + " (chưa có logic).");
            // });

            // Keep existing add handler (unchanged)
            $("#addNewProgramBtn").on("click", function () {
                const programName = ($("#programName").val() || "").toString().trim();
                const majorText = ($("#major").val() || "").toString().trim();
                const facultyText = ($("#faculty").val() || "").toString().trim();
                const language = ($("#language").val() || "").toString().trim();
                const description = ($("#description").val() || "").toString().trim();
                const numberOfSemestersRaw = $("#numberOfSemesters").val();
                const numberOfSemesters = parseInt(numberOfSemestersRaw, 10);
                const obligatedCredits = parseFloat($("#obligatedCredits").val() || "0") || 0;
                const electiveCredits = parseFloat($("#internshipCredits").val() || "0") || 0;
                const totalCredits = obligatedCredits + electiveCredits;

                $("#totalCredits").val(totalCredits);

                if (!programName) { alert("Program name is required."); return; }
                if (isNaN(numberOfSemesters) || numberOfSemesters <= 0) { alert("Number of semesters must be a positive integer."); return; }
                if (obligatedCredits < 0 || electiveCredits < 0) { alert("Credit values must be non-negative."); return; }

                let majorId = null;
                if (majorText) {
                    const majOpt = $("#majorList option").filter(function () { return $(this).val() === majorText; }).first();
                    if (majOpt.length) majorId = parseInt(majOpt.data("id")) || null;
                }
                let facultyId = null;
                if (facultyText) {
                    const facOpt = $("#facultyList option").filter(function () { return $(this).val() === facultyText; }).first();
                    if (facOpt.length) facultyId = parseInt(facOpt.data("id")) || null;
                }

                const payload = {
                    AcademicProgramName: programName,
                    MajorId: majorId,
                    FacultyId: facultyId,
                    Language: language,
                    Description: description,
                    NumberOfSemester: numberOfSemesters,
                    ObligatedCredits: obligatedCredits,
                    ElectiveCredits: electiveCredits,
                    TotalOfRequiredCredits: totalCredits
                };

                $.ajax({
                    url: '/AcademicProgram/AddAcademicProgram',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (resp) {
                        alert(resp?.message || "Program added successfully.");
                        $("#addProgramModal").hide();
                        location.reload();
                    },
                    error: function (xhr) {
                        let msg = "Failed to add program.";
                        try {
                            const json = xhr.responseJSON || JSON.parse(xhr.responseText || "{}");
                            if (json && json.message) msg = json.message;
                        } catch (e) { }
                        alert(msg);
                    }
                });
            });

            // --- Filtering + infinite scroll logic (based on Course.cshtml) ---
            let currentPage = 1;
            let totalPages = 1;
            let isLoading = false;
            // start counter from server-rendered rows
            let renderedCount = @Model.AcademicPrograms.Count();
            let sttCounter = renderedCount;

            let filters = {}; // active filters object

            function parseNullableNumber(selector) {
                const v = $(selector).val();
                if (v === "" || v === null || v === undefined) return null;
                const n = parseFloat(v);
                return isNaN(n) ? null : n;
            }
            function setFieldError($el, message) {
                $el.addClass("is-invalid");
                let $fb = $el.next(".invalid-feedback");
                if (!$fb.length) { $fb = $('<div class="invalid-feedback"></div>').insertAfter($el); }
                $fb.text(message);
            }
            function clearFieldError($el) {
                $el.removeClass("is-invalid");
                const $fb = $el.next(".invalid-feedback");
                if ($fb.length) $fb.remove();
            }

            function validateRangePair(minSelector, maxSelector, label) {
                const $min = $(minSelector), $max = $(maxSelector);
                clearFieldError($min); clearFieldError($max);
                const min = parseNullableNumber(minSelector);
                const max = parseNullableNumber(maxSelector);
                if (min !== null && max !== null && min > max) {
                    setFieldError($min, label + " min must be less than or equal to max.");
                    setFieldError($max, "");
                    return false;
                }
                return true;
            }

            // Wire range validation
            ["Obligated","Elective","Total"].forEach(function(prefix) {
                const minSel = "#filter" + prefix + "Min";
                const maxSel = "#filter" + prefix + "Max";
                $(minSel + "," + maxSel).on("input change", function() {
                    validateRangePair(minSel, maxSel, prefix + " credits");
                });
            });

            // Reset table and load from page 1 according to filters
            function resetAndLoad() {
                $("tbody").empty();
                sttCounter = 0;
                currentPage = 0;
                totalPages = 1;
                loadMorePrograms();
            }

            function autoFillIfNeeded() {
                if ($(document).height() <= $(window).height() && currentPage < totalPages) {
                    loadMorePrograms();
                }
            }

            function loadMorePrograms() {
                if (isLoading) return;
                if (currentPage >= totalPages) return;

                isLoading = true;
                currentPage++;

                $.ajax({
                    url: "/AcademicProgram/GetPrograms",
                    method: "GET",
                    data: Object.assign({ page: currentPage }, filters),
                    success: function (data) {
                        if (data.programs && data.programs.length > 0) {
                            data.programs.forEach(function (p) {
                                sttCounter++;
                                let majorCell = p.majorName ? p.majorName : "<em>Not set yet</em>";
                                let facultyCell = p.facultyName ? p.facultyName : "<em>Not set yet</em>";
                                let descCell = p.description ? (p.description.length > 50 ? p.description.substring(0,50) + "..." : p.description) : "<em>Not set yet</em>";
                                let row = `
                                    <tr>
                                        <td>
                                            <button class="btn btn-info btn-sm view-details" data-id="${p.academicProgramId}">View</button>
                                        </td>
                                        <td>${p.academicProgramId}</td>
                                        <td>
                                            <a href="/Admin/ProgramDetail/${p.academicProgramId}" class="view-details" data-id="${p.academicProgramId}">${p.academicProgramName || "N/A"}</a>
                                        </td>
                                        <td>${majorCell}</td>
                                        <td>${facultyCell}</td>
                                        <td>${p.language || "N/A"}</td>
                                        <td>${descCell}</td>
                                        <td>${p.numberOfSemester ?? ""}</td>
                                        <td>${p.totalCredits ?? ""}</td>
                                        <td>${p.obligatedCredits ?? ""}</td>
                                        <td>${p.electiveCredits ?? ""}</td>
                                    </tr>`;
                                $("tbody").append(row);
                            });
                            totalPages = data.totalPages || totalPages;
                        }
                        isLoading = false;
                        autoFillIfNeeded();
                    },
                    error: function (xhr) {
                        console.error("Failed to load programs", xhr);
                        isLoading = false;
                    }
                });
            }

            // Apply filter handler
            $("#applyFilterBtn").off("click").on("click", function() {
                const pairsValid =
                    validateRangePair("#filterObligatedMin", "#filterObligatedMax", "Obligated")
                    & validateRangePair("#filterElectiveMin", "#filterElectiveMax", "Elective")
                    & validateRangePair("#filterTotalMin", "#filterTotalMax", "Total");
                if (!pairsValid) {
                    const $firstInvalid = $(".is-invalid").first();
                    if ($firstInvalid.length) $firstInvalid.focus();
                    return;
                }

                const name = $("#filterProgramName").val()?.toString().trim();
                const numberOfSemester = $("#filterNumberOfSemesters").val();
                const majorId = $("#filterMajorInProgram").val();
                const facultyId = $("#filterFacultyInCharge").val();
                const language = $("#filterLanguage").val()?.toString().trim();
                const description = $("#filterDescription").val()?.toString().trim();

                filters = {};
                if (name) filters.name = name;
                if (numberOfSemester !== "") filters.numberOfSemester = numberOfSemester;
                if (majorId && majorId !== "") filters.majorId = majorId;
                if (facultyId && facultyId !== "") filters.facultyId = facultyId;
                if (language) filters.language = language;
                if (description) filters.description = description;

                const obligatedMin = $("#filterObligatedMin").val();
                const obligatedMax = $("#filterObligatedMax").val();
                if (obligatedMin !== "") filters.obligatedMin = obligatedMin;
                if (obligatedMax !== "") filters.obligatedMax = obligatedMax;

                const electiveMin = $("#filterElectiveMin").val();
                const electiveMax = $("#filterElectiveMax").val();
                if (electiveMin !== "") filters.electiveMin = electiveMin;
                if (electiveMax !== "") filters.electiveMax = electiveMax;

                const totalMin = $("#filterTotalMin").val();
                const totalMax = $("#filterTotalMax").val();
                if (totalMin !== "") filters.totalMin = totalMin;
                if (totalMax !== "") filters.totalMax = totalMax;

                const anyFilter = Object.keys(filters).length > 0;
                if (anyFilter) $("#filterProgramsBtn").addClass("has-active-filters"); else $("#filterProgramsBtn").removeClass("has-active-filters");

                $("#filterModal").hide();
                resetAndLoad();
            });

            // Clear filter handler
            $("#clearFilterBtn").on("click", function () {
                $("#filterProgramName").val("");
                $("#filterNumberOfSemesters").val("");
                $("#filterMajorInProgram").val("");
                $("#filterFacultyInCharge").val("");
                $("#filterLanguage").val("");
                $("#filterObligatedMin").val("");
                $("#filterObligatedMax").val("");
                $("#filterElectiveMin").val("");
                $("#filterElectiveMax").val("");
                $("#filterTotalMin").val("");
                $("#filterTotalMax").val("");
                $("#filterDescription").val("");
                filters = {};
                $("#filterProgramsBtn").removeClass("has-active-filters");
                resetAndLoad();
            });

            // Infinite scrolling throttle
            let scrollTimer = null;
            $(window).on('scroll', function() {
                if (scrollTimer) return;
                scrollTimer = setTimeout(function() {
                    scrollTimer = null;
                    if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                        loadMorePrograms();
                    }
                }, 150);
            });

            // Try to auto-fill if page content short
            autoFillIfNeeded();

        });
    </script>
}
